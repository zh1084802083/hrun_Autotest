config:
    name: 续租退租房源合同
    variables:
        access_token: ${get_token()}
        areaSize: ${str_to_int(10)}
    verify: false
    export:
        - room_id
        - building_id
        - contract_id
        - room_number
teststeps:
-   name: 获取楼宇id
    testcase: testcases/Buildings/buildings.yml

-   name: 获取合同列表
    request:
        headers:
            authorization: Bearer $access_token
        params:
          page: 0
          size: 10
          archived: false
          buildingIds: $building_id
          customFieldFilter: '[]'
        method: GET
        url:
            ${ENV(api_url)}/v2/contracts
    extract:
      - contract_id: body.content[?auditStatusName==\'已退租\'].id|[0]
      - room_id: body.content[?auditStatusName==\'已退租\'].resources.0.resourceId|[0]
      - room_number: body.content[?auditStatusName==\'已退租\'].resources.0.roomNumber|[0]
    validate:
    -   eq:
        - status_code
        - 200

-   name: 生成续租房源合同租金明细
    request:
        headers:
            authorization: Bearer $access_token
        json:
            baseTerm:
                areaSize: $areaSize
                calculateOrder: AREA_FIRST
                deposit: 1
                depositPayEnumDesc: 租金保证金
                depositUnitEnum: MONTH
                leaseBeginDate: ${begin_date_rw()}
                leaseEndDate: ${end_180()}
                monetaryUnit: 人民币CNY
                precisionEnum: RESULT
                signDate: ${begin_date()}
                spaceUnit: P
                theoryRounded: false
                unitPricePrecision: 2
            depositIncreasingRates: []
            discounts: []
            increasingRates: []
            leaseTerms:
            -   calculateEnum: MONTH
                dayNumberForYear: 365
                deposit: false
                intervalMonth: 1
                leaseComputeWay: FIXED_MONEY
                leaseDivideRoleEnum: NORMAL
                leaseTermType: RENT
                leaseTermTypeDesc: 租金
                monetaryUnit: 人民币CNY
                payInAdvanceDay: 1
                paymentDateEnum: WORKDAY
                price: 10
                priceUnitEnum: D
                termBeginDate: ${begin_date_rw()}
                termEndDate: ${end_180()}
        method: POST
        url: ${ENV(api_url)}/v2/contracts/pays
    extract:
        - theoryPayDate_0: content.0.theoryPayDate
        - theoryPayDate_1: content.1.theoryPayDate
        - theoryPayDate_2: content.2.theoryPayDate
        - theoryPayDate_3: content.3.theoryPayDate
        - theoryPayDate_4: content.4.theoryPayDate
        - theoryPayDate_5: content.5.theoryPayDate
        - theoryPayDate_6: content.6.theoryPayDate
        - startDate_0: content.0.startDate
        - startDate_1: content.1.startDate
        - startDate_2: content.2.startDate
        - startDate_3: content.3.startDate
        - startDate_4: content.4.startDate
        - startDate_5: content.5.startDate
        - startDate_6: content.6.startDate
        - endDate_0: content.0.endDate
        - endDate_1: content.1.endDate
        - endDate_2: content.2.endDate
        - endDate_3: content.3.endDate
        - endDate_4: content.4.endDate
        - endDate_5: content.5.endDate
        - endDate_6: content.6.endDate
        - finalPrice_0: content.0.finalPrice
        - finalPrice_1: content.1.finalPrice
        - finalPrice_2: content.2.finalPrice
        - finalPrice_3: content.3.finalPrice
        - finalPrice_4: content.4.finalPrice
        - finalPrice_5: content.5.finalPrice
        - finalPrice_6: content.6.finalPrice
        - theoryPayMoney_0: content.0.theoryPayMoney
        - theoryPayMoney_1: content.1.theoryPayMoney
        - theoryPayMoney_2: content.2.theoryPayMoney
        - theoryPayMoney_3: content.3.theoryPayMoney
        - theoryPayMoney_4: content.4.theoryPayMoney
        - theoryPayMoney_5: content.5.theoryPayMoney
        - theoryPayMoney_6: content.6.theoryPayMoney
        - payMoney_0: content.0.payMoney
        - payMoney_1: content.1.payMoney
        - payMoney_2: content.2.payMoney
        - payMoney_3: content.3.payMoney
        - payMoney_4: content.4.payMoney
        - payMoney_5: content.5.payMoney
        - payMoney_6: content.6.payMoney
        - commissionStandard_0: content.0.commissionStandard
        - commissionStandard_1: content.1.commissionStandard
        - commissionStandard_2: content.2.commissionStandard
        - commissionStandard_3: content.3.commissionStandard
        - commissionStandard_4: content.4.commissionStandard
        - commissionStandard_5: content.5.commissionStandard
        - commissionStandard_6: content.6.commissionStandard
        - planRentAmount_0: content.0.planRentAmount
        - planRentAmount_1: content.1.planRentAmount
        - planRentAmount_2: content.2.planRentAmount
        - planRentAmount_3: content.3.planRentAmount
        - planRentAmount_4: content.4.planRentAmount
        - planRentAmount_5: content.5.planRentAmount
        - planRentAmount_6: content.6.planRentAmount
    validate:
    -   eq:
        - status_code
        - 200

-   name: 计算退租协议所需金额
    request:
        headers:
            authorization: Bearer $access_token
        method: GET
        params:
            terminationDate: ${end_date()}
        url: ${ENV(api_url)}/v3/contracts/$contract_id/termination/finance/term
    extract:
        - billId_0: content.rentals.0.billId
        - curRemainingAmount_0: content.rentals.0.curRemainingAmount
        - expenseTermId_0: content.rentals.0.expenseTermId
        - t_endDate_0: content.rentals.0.endDate
        - t_startDate_0: content.rentals.0.endDate
        - t_payDate_0: content.rentals.0.payDate
        - primeAmount_0: content.rentals.0.primeAmount
        - remainingAmount_0: content.rentals.0.remainingAmount
        - settledStatus_0: content.rentals.0.settledStatus
        - tempCurRemainingAmount_0: content.rentals.0.tempCurRemainingAmount
        - theoryAmount_0: content.rentals.0.theoryAmount
        - diffAmount_0: content.rentals.0.diffAmount
    validate:
    -   eq:
        - status_code
        - 200
    teardown_hooks:
        - ${wait($response,1)}

-   name: 续租已退租合同
    request:
        headers:
            authorization: Bearer $access_token
        json:
            newContract:
                baseTerm:
                    areaSize: $areaSize
                    calculateOrder: AREA_FIRST
                    contractLeaseDateRule: DEFAULT
                    contractNo: '001'
                    leaseBeginDate: ${begin_date_rw()}
                    leaseEndDate: ${end_180()}
                    precisionEnum: RESULT
                    signDate: ${begin_date()}
                    spaceUnit: P
                    theoryRounded: false
                    unitPricePrecision: 2
                contractNo: '001'
                customKeywords: []
                expenseTerms:
                -   areaSize: $areaSize
                    buildingType: OFFICE
                    contractExpenseTermName: 租赁条款
                    contractPays:
                    -   applyDate: null
                        carryAmount: 0
                        carryForwards: []
                        commissionMoney: 0
                        commissionRateModels: null
                        commissionStandard: $commissionStandard_0
                        payMoney: $payMoney_0
                        planRentAmount: $planRentAmount_0
                        startDate: $startDate_0
                        endDate: $endDate_0
                        theoryPayDate: $theoryPayDate_0
                        theoryPayMoney: $theoryPayMoney_0
                        finalPrice: $finalPrice_0
                        commissionStatus: NONE
                        contractId: null
                        contractPayRentCommission: NORMAL
                        deposit: false
                        generateBills: false
                        id: null
                        increaseNumber: null
                        increaseRateEnum: null
                        key: QTW_lyJlO
                        monetaryUnit: 人民币CNY
                        moneyDiscount: true
                        normalIndex: 1-1
                        payEnum: RENT
                        payEnumDesc: 租金
                        priceUnitEnum: D
                        primaryTermIndex: 1
                        tempPayMoney: null
                        termIndex: 1
                    -   applyDate: null
                        carryAmount: 0
                        carryForwards: []
                        commissionMoney: 0
                        commissionRateModels: null
                        commissionStandard: $commissionStandard_1
                        payMoney: $payMoney_1
                        planRentAmount: $planRentAmount_1
                        startDate: $startDate_1
                        endDate: $endDate_1
                        theoryPayDate: $theoryPayDate_1
                        theoryPayMoney: $theoryPayMoney_1
                        finalPrice: $finalPrice_1
                        commissionStatus: NONE
                        contractId: null
                        contractPayRentCommission: NORMAL
                        deposit: false
                        generateBills: false
                        id: null
                        increaseNumber: null
                        increaseRateEnum: null
                        key: FpYUeSU0x4
                        monetaryUnit: 人民币CNY
                        moneyDiscount: true
                        normalIndex: 1-2
                        payEnum: RENT
                        payEnumDesc: 租金
                        priceUnitEnum: D
                        primaryTermIndex: 2
                        tempPayMoney: null
                        termIndex: 2
                    -   applyDate: null
                        carryAmount: 0
                        carryForwards: []
                        commissionMoney: 0
                        commissionRateModels: null
                        commissionStandard: $commissionStandard_2
                        payMoney: $payMoney_2
                        planRentAmount: $planRentAmount_2
                        startDate: $startDate_2
                        endDate: $endDate_2
                        theoryPayDate: $theoryPayDate_2
                        theoryPayMoney: $theoryPayMoney_2
                        finalPrice: $finalPrice_2
                        commissionStatus: NONE
                        contractId: null
                        contractPayRentCommission: NORMAL
                        deposit: false
                        generateBills: false
                        id: null
                        increaseNumber: null
                        increaseRateEnum: null
                        key: Y5tYzG6bfx
                        monetaryUnit: 人民币CNY
                        moneyDiscount: true
                        normalIndex: 1-3
                        payEnum: RENT
                        payEnumDesc: 租金
                        priceUnitEnum: D
                        primaryTermIndex: 3
                        tempPayMoney: null
                        termIndex: 3
                    -   applyDate: null
                        carryAmount: 0
                        carryForwards: []
                        commissionMoney: 0
                        commissionRateModels: null
                        commissionStandard: $commissionStandard_3
                        payMoney: $payMoney_3
                        planRentAmount: $planRentAmount_3
                        startDate: $startDate_3
                        endDate: $endDate_3
                        theoryPayDate: $theoryPayDate_3
                        theoryPayMoney: $theoryPayMoney_3
                        finalPrice: $finalPrice_3
                        commissionStatus: NONE
                        contractId: null
                        contractPayRentCommission: NORMAL
                        deposit: false
                        generateBills: false
                        id: null
                        increaseNumber: null
                        increaseRateEnum: null
                        key: PGdpuVGiPb
                        monetaryUnit: 人民币CNY
                        moneyDiscount: true
                        normalIndex: 1-4
                        payEnum: RENT
                        payEnumDesc: 租金
                        priceUnitEnum: D
                        primaryTermIndex: 4
                        tempPayMoney: null
                        termIndex: 4
                    -   applyDate: null
                        carryAmount: 0
                        carryForwards: []
                        commissionMoney: 0
                        commissionRateModels: null
                        commissionStandard: $commissionStandard_4
                        payMoney: $payMoney_4
                        planRentAmount: $planRentAmount_4
                        startDate: $startDate_4
                        endDate: $endDate_4
                        theoryPayDate: $theoryPayDate_4
                        theoryPayMoney: $theoryPayMoney_4
                        finalPrice: $finalPrice_4
                        commissionStatus: NONE
                        contractId: null
                        contractPayRentCommission: NORMAL
                        deposit: false
                        generateBills: false
                        id: null
                        increaseNumber: null
                        increaseRateEnum: null
                        key: TlYQbkcWPy
                        monetaryUnit: 人民币CNY
                        moneyDiscount: true
                        normalIndex: 1-5
                        payEnum: RENT
                        payEnumDesc: 租金
                        priceUnitEnum: D
                        primaryTermIndex: 5
                        tempPayMoney: null
                        termIndex: 5
                    -   applyDate: null
                        carryAmount: 0
                        carryForwards: []
                        commissionMoney: 0
                        commissionRateModels: null
                        commissionStandard: $commissionStandard_5
                        payMoney: $payMoney_5
                        planRentAmount: $planRentAmount_5
                        startDate: $startDate_5
                        endDate: $endDate_5
                        theoryPayDate: $theoryPayDate_5
                        theoryPayMoney: $theoryPayMoney_5
                        finalPrice: $finalPrice_5
                        commissionStatus: NONE
                        contractId: null
                        contractPayRentCommission: NORMAL
                        deposit: false
                        generateBills: false
                        id: null
                        increaseNumber: null
                        increaseRateEnum: null
                        key: TlYQbkcWPy
                        monetaryUnit: 人民币CNY
                        moneyDiscount: true
                        normalIndex: 1-6
                        payEnum: RENT
                        payEnumDesc: 租金
                        priceUnitEnum: D
                        primaryTermIndex: 6
                        tempPayMoney: null
                        termIndex: 6
                    -   applyDate: null
                        carryAmount: 0
                        carryForwards: []
                        commissionMoney: 0
                        commissionRateModels: null
                        commissionStandard: $commissionStandard_6
                        payMoney: $payMoney_6
                        planRentAmount: $planRentAmount_6
                        startDate: $startDate_6
                        endDate: $endDate_6
                        theoryPayDate: $theoryPayDate_6
                        theoryPayMoney: $theoryPayMoney_6
                        finalPrice: $finalPrice_6
                        commissionStatus: NONE
                        contractId: null
                        contractPayRentCommission: NORMAL
                        deposit: true
                        generateBills: false
                        id: null
                        increaseNumber: null
                        increaseRateEnum: null
                        key: _4sXeknYKR
                        monetaryUnit: 人民币CNY
                        moneyDiscount: false
                        normalIndex: null
                        payEnum: RENT_DEPOSIT
                        payEnumDesc: 租金保证金
                        priceUnitEnum: null
                        primaryTermIndex: null
                        tempPayMoney: null
                        termIndex: 7
                    deposit: 1
                    depositIncreasingRates: []
                    depositUnitEnum: MONTH
                    discounts: []
                    expenseTermType: RENT_TERM
                    increasingRates: []
                    itemPermission: RENT_PERMISSION
                    leaseTerms:
                    -   calculateEnum: MONTH
                        dayNumberForYear: 365
                        deposit: false
                        intervalMonth: 1
                        leaseComputeWay: FIXED_MONEY
                        leaseDivideRoleEnum: NORMAL
                        leaseTermType: RENT
                        leaseTermTypeDesc: 租金
                        monetaryUnit: 人民币CNY
                        payInAdvanceDay: 1
                        paymentDateEnum: WORKDAY
                        price: 10
                        priceUnitEnum: D
                        termBeginDate: ${begin_date_rw()}
                        termEndDate: ${end_180()}
                    monetaryUnit: 人民币CNY
                    resourceIds:
                    - $room_id
                    resourceType: ROOM
                    spaceUnit: P
                    termIndex: 1
                followId: 4990
                followName: '13787340624'
                industryName: null
                jsonData: '[]'
                legalPerson:
                    name: 李传根
                remarkTerms: []
                resourceIds:
                - $room_id
                resourceType: ROOM
                tags: []
                tenantId: 78327
                tenantName: 湖南神雀网络科技有限公司
                tenantNo: null
            newContractStartDate: ${begin_date_rw()}
            terminationContractCarryForward:
                billList:
                -   action: IN
                    adjustAmount: 0
                    billId: $billId_0
                    billType: 租金
                    carryAmount: null
                    carryBills: []
                    carryDirectionEnum: null
                    curRemainingAmount: $curRemainingAmount_0
                    deposit: false
                    diffAmount: $diffAmount_0
                    endDate: $t_endDate_0
                    expenseTermId: $expenseTermId_0
                    historyCarryAmount: 0
                    historyCarryBills: []
                    historyCarryInAmount: 0
                    historyCarryOutAmount: 0
                    id: null
                    memo: 第1期应收账单
                    monetaryUnit: 人民币CNY
                    overDueFineAmount: null
                    payDate: $t_payDate_0
                    payedAmount: 0
                    primeAmount: $primeAmount_0
                    remainingAmount: $remainingAmount_0
                    settledStatus: $settledStatus_0
                    startDate: $t_startDate_0
                    tempCurRemainingAmount: $tempCurRemainingAmount_0
                    theoryAmount: $theoryAmount_0
                contractId: $contract_id
                expenseList: []
        method: POST
        params:
            id: $contract_id
        url: ${ENV(api_url)}/v3/contracts/renew
    extract:
        - contract_newId: content
    validate:
    -   eq:
        - status_code
        - 201
    teardown_hooks:
        - ${wait($response,1)}


-   name: 提交续租已退租合同
    request:
        headers:
            content-type: application/json
            authorization: Bearer $access_token
        json:
            buildingIds: [$building_id]
            subDomainType: "NEW_APPROVAL"
            domainType: "CONTRACT"
            customerId: 1013
            description: "湖南神雀网络科技有限公司/测试楼宇/$room_number"
            objectId: $contract_newId
        method: POST
        url: ${ENV(api_url)}/oa/start
    setup_hooks:
        - ${set_contract_sh()}
    validate:
    -   eq:
        - status_code
        - 200
    teardown_hooks:
        - ${wait($response,1)}

-   name: 作废已续租合同
    request:
        headers:
            content-type: application/json
            authorization: Bearer $access_token
        json:
            memo: "1"
            action: "CLOSE_ALL_BILLS"
            amortizationScheduleDelete: true
        method: POST
        url: ${ENV(api_url)}/v2/contracts/$contract_newId/nullification
        params:
            buildingId: $building_id
    validate:
    -   eq:
        - status_code
        - 201
    teardown_hooks:
        - ${wait($response,0.5)}

-   name: 生效作废合同
    request:
        headers:
            content-type: application/json
            authorization: Bearer $access_token
        json:
            buildingIds: [$building_id]
            subDomainType: "NULLIFICATION_APPROVAL"
            domainType: "CONTRACT"
            customerId: 1013
            description: "湖南神雀网络科技有限公司/测试楼宇/$room_number"
            objectId: $contract_newId
        method: POST
        url: ${ENV(api_url)}/oa/start
    setup_hooks:
        - ${set_contract_sh()}
    validate:
    -   eq:
        - status_code
        - 200
